// Raastaa Backend - Prisma Schema
// Gamified Street Food Discovery Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MODEL ====================
model User {
  uuid             String   @id @default(uuid())
  email            String   @unique
  phone            String   @unique
  username         String   @unique
  password_hash    String
  display_name     String
  dob              DateTime
  profile_picture  String?
  food_preferences String[]
  referral_source  String?
  bio              String?  @db.VarChar(500)
  social_links     Json?
  ui_preferences   Json     @default("{\"theme\":\"light\",\"language\":\"en\"}")
  registered_ip    String
  is_vendor        Boolean  @default(false)
  account_status   String   @default("ACTIVE") // ACTIVE | SUSPENDED | PENDING_VERIFICATION

  // Cached counts
  followers_count Int @default(0)
  following_count Int @default(0)

  // Gamification
  bottle_caps BigInt @default(0)
  xp          BigInt @default(0)
  level       Int    @default(1)

  // Activity stats
  expeditions_completed Int @default(0)
  vendors_visited       Int @default(0)
  posts_count           Int @default(0)

  // Admin
  is_admin Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  posts                    Post[]
  comments                 Comment[]
  ratings                  Rating[]
  createdExpeditions       Expedition[]
  expeditionParticipations ExpeditionParticipant[]
  likes                    Like[]
  bottleCapTransactions    BottleCapTransaction[]

  // Social Relations
  followersRel  UserFollows[]   @relation("Following")
  followingRel  UserFollows[]   @relation("Followers")
  vendorFollows VendorFollows[]

  // Friendships
  friendshipsA Friendship[] @relation("UserA")
  friendshipsB Friendship[] @relation("UserB")

  // Reports
  contentFlagsReported ContentFlag[]

  // Referrals
  referralCode ReferralCode?
  referredBy   ReferralUse?  @relation("ReferredUser")

  // Notifications
  notifications Notification[]

  // Achievements
  userAchievements UserAchievement[]

  @@index([username])
  @@index([email])
  @@index([phone])
  @@index([account_status])
  @@index([created_at])
}

// ==================== VENDOR MODEL ====================
model Vendor {
  uuid              String   @id @default(uuid())
  email             String?  @unique
  phone             String?  @unique
  password_hash     String
  vendor_name       String
  store_name        String
  store_description String   @db.VarChar(1000)
  operating_hours   Json
  upi_id            String
  menu_photos       String[]
  stall_photos      String[]
  primary_lat       Float
  primary_lng       Float
  food_categories   String[]

  // Denormalized ratings
  rating_hygiene   Float @default(0)
  rating_value     Float @default(0)
  rating_taste     Float @default(0)
  rating_recommend Float @default(0)
  rating_overall   Float @default(0)
  total_ratings    Int   @default(0)

  // Status
  verification_status String  @default("PENDING_REVIEW") // PENDING_REVIEW | UNVERIFIED | BASIC | VERIFIED | PREMIUM
  is_currently_open   Boolean @default(false)
  rejection_reason    String?

  // Metadata
  price_range     String   @default("MODERATE") // BUDGET | MODERATE | PREMIUM
  specialties     String[]
  tags            String[]
  followers_count Int      @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  ratings           Rating[]
  posts             Post[]
  vendorFollowers   VendorFollows[]
  location          VendorLocation?
  expeditionVendors ExpeditionVendor[]
  menuItems         MenuItem[]

  @@index([store_name])
  @@index([food_categories])
  @@index([verification_status])
  @@index([rating_overall])
  @@index([created_at])
}

// ==================== MENU ITEMS ====================
model MenuItem {
  uuid        String  @id @default(uuid())
  vendor_id   String
  name        String
  description String? @db.VarChar(500)
  price       Float
  image_url   String?
  category    String?
  is_veg      Boolean @default(true)
  is_bestseller Boolean @default(false)
  is_available Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  vendor Vendor @relation(fields: [vendor_id], references: [uuid], onDelete: Cascade)

  @@index([vendor_id])
}

// ==================== SOCIAL GRAPH ====================
model UserFollows {
  follower_id  String
  following_id String
  created_at   DateTime @default(now())

  follower  User @relation("Followers", fields: [follower_id], references: [uuid], onDelete: Cascade)
  following User @relation("Following", fields: [following_id], references: [uuid], onDelete: Cascade)

  @@id([follower_id, following_id])
  @@index([following_id])
  @@index([follower_id])
}

model VendorFollows {
  user_id               String
  vendor_id             String
  created_at            DateTime @default(now())
  notifications_enabled Boolean  @default(true)

  user   User   @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendor_id], references: [uuid], onDelete: Cascade)

  @@id([user_id, vendor_id])
  @@index([vendor_id])
  @@index([user_id])
}

model Friendship {
  id           String    @id @default(uuid())
  user_a       String
  user_b       String
  status       String    @default("PENDING") // PENDING | ACCEPTED | BLOCKED
  initiated_by String
  created_at   DateTime  @default(now())
  accepted_at  DateTime?

  userA User @relation("UserA", fields: [user_a], references: [uuid], onDelete: Cascade)
  userB User @relation("UserB", fields: [user_b], references: [uuid], onDelete: Cascade)

  @@unique([user_a, user_b])
  @@index([user_a])
  @@index([user_b])
  @@index([status])
}

// ==================== VENDOR LOCATION ====================
model VendorLocation {
  vendor_id       String   @id
  lat             Float
  lng             Float
  accuracy_meters Int      @default(100)
  is_active       Boolean  @default(true)
  updated_at      DateTime @updatedAt

  vendor Vendor @relation(fields: [vendor_id], references: [uuid], onDelete: Cascade)
}

// ==================== POSTS ====================
model Post {
  uuid          String   @id @default(uuid())
  author_id     String
  vendor_id     String?
  expedition_id String?

  // Content
  content_type String // TEXT | IMAGE | CAROUSEL | VIDEO
  text_content String?  @db.VarChar(2000)
  media_urls   String[]

  // Engagement
  likes_count    Int @default(0)
  comments_count Int @default(0)
  shares_count   Int @default(0)
  saves_count    Int @default(0)

  // Discovery
  hashtags     String[]
  mentions     String[]
  location_lat Float?
  location_lng Float?
  location_name String?

  // Moderation
  status String @default("ACTIVE") // ACTIVE | HIDDEN | DELETED | FLAGGED

  // Timestamps
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  edited_at  DateTime?
  is_edited  Boolean   @default(false)

  // Relations
  author   User      @relation(fields: [author_id], references: [uuid], onDelete: Cascade)
  vendor   Vendor?   @relation(fields: [vendor_id], references: [uuid], onDelete: SetNull)
  comments Comment[]
  likes    Like[]
  saves    SavedPost[]

  @@index([author_id, created_at(sort: Desc)])
  @@index([vendor_id, created_at(sort: Desc)])
  @@index([created_at(sort: Desc)])
  @@index([hashtags])
  @@index([status])
}

// ==================== SAVED POSTS ====================
model SavedPost {
  id         String   @id @default(uuid())
  user_id    String
  post_id    String
  created_at DateTime @default(now())

  post Post @relation(fields: [post_id], references: [uuid], onDelete: Cascade)

  @@unique([user_id, post_id])
  @@index([user_id])
}

// ==================== COMMENTS ====================
model Comment {
  uuid             String   @id @default(uuid())
  post_id          String
  author_id        String
  reply_to_user_id String?
  parent_comment_id String?

  content     String   @db.VarChar(500)
  mentions    String[]
  likes_count Int      @default(0)
  status      String   @default("ACTIVE") // ACTIVE | DELETED | FLAGGED

  created_at DateTime  @default(now())
  edited_at  DateTime?
  is_edited  Boolean   @default(false)

  post   Post @relation(fields: [post_id], references: [uuid], onDelete: Cascade)
  author User @relation(fields: [author_id], references: [uuid], onDelete: Cascade)

  @@index([post_id, created_at(sort: Asc)])
  @@index([author_id])
}

// ==================== LIKES (Polymorphic) ====================
model Like {
  id          String   @id @default(uuid())
  user_id     String
  target_type String // POST | COMMENT
  target_id   String
  created_at  DateTime @default(now())

  user User  @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  post Post? @relation(fields: [target_id], references: [uuid], onDelete: Cascade)

  @@unique([user_id, target_type, target_id])
  @@index([target_type, target_id])
  @@index([user_id])
}

// ==================== EXPEDITIONS ====================
model Expedition {
  uuid       String @id @default(uuid())
  type       String // SOLO | TEAM
  creator_id String

  title        String  @db.VarChar(100)
  description  String? @db.VarChar(500)
  planned_date DateTime @db.Date
  start_time   String?
  cover_image  String?

  status       String    @default("DRAFT") // DRAFT | PLANNED | IN_PROGRESS | COMPLETED | CANCELLED
  started_at   DateTime?
  completed_at DateTime?

  vendor_count            Int @default(0)
  estimated_duration_mins Int?
  max_participants        Int @default(10)

  actual_duration_mins   Int?
  total_spent            Float?
  distance_walked_meters Int?

  bottle_caps_earned    Int      @default(0)
  achievements_unlocked String[]

  // Privacy
  is_public Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  creator      User                    @relation(fields: [creator_id], references: [uuid], onDelete: Cascade)
  participants ExpeditionParticipant[]
  vendors      ExpeditionVendor[]

  @@index([creator_id, status])
  @@index([planned_date])
  @@index([status])
  @@index([is_public, planned_date])
}

model ExpeditionParticipant {
  expedition_id String
  user_id       String
  role          String    @default("PARTICIPANT") // CREATOR | PARTICIPANT
  status        String    @default("INVITED") // INVITED | ACCEPTED | DECLINED
  joined_at     DateTime?

  expedition Expedition @relation(fields: [expedition_id], references: [uuid], onDelete: Cascade)
  user       User       @relation(fields: [user_id], references: [uuid], onDelete: Cascade)

  @@id([expedition_id, user_id])
  @@index([user_id])
}

model ExpeditionVendor {
  expedition_id    String
  vendor_id        String
  order_index      Int
  status           String    @default("PLANNED") // PLANNED | VISITED | SKIPPED
  visited_at       DateTime?
  rating_submitted Boolean   @default(false)
  notes            String?

  expedition Expedition @relation(fields: [expedition_id], references: [uuid], onDelete: Cascade)
  vendor     Vendor     @relation(fields: [vendor_id], references: [uuid], onDelete: Cascade)

  @@id([expedition_id, vendor_id])
  @@index([expedition_id, order_index])
}

// ==================== RATINGS ====================
model Rating {
  uuid          String  @id @default(uuid())
  user_id       String
  vendor_id     String
  expedition_id String?

  hygiene         Int // 1-5
  value_for_money Int // 1-5
  taste           Int // 1-5
  recommendation  Int // 1-5

  review_text String?  @db.VarChar(1000)
  photos      String[]

  // Engagement
  helpful_count Int @default(0)

  // Status
  status String @default("ACTIVE") // ACTIVE | HIDDEN | FLAGGED

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user   User   @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendor_id], references: [uuid], onDelete: Cascade)

  @@unique([user_id, vendor_id])
  @@index([vendor_id])
  @@index([created_at(sort: Desc)])
}

// ==================== BOTTLE CAPS ====================
model BottleCapTransaction {
  id            String   @id @default(uuid())
  user_id       String
  amount        Int // Positive = earn, Negative = spend
  action_type   String
  reference_id  String?
  reference_type String?
  description   String?
  balance_after BigInt
  created_at    DateTime @default(now())

  user User @relation(fields: [user_id], references: [uuid], onDelete: Cascade)

  @@index([user_id, created_at(sort: Desc)])
  @@index([action_type])
}

// ==================== ACHIEVEMENTS ====================
model Achievement {
  id          String @id @default(uuid())
  code        String @unique
  name        String
  description String
  icon_url    String?
  category    String // EXPLORER | SOCIAL | FOODIE | CONTRIBUTOR | SPECIAL
  tier        String // BRONZE | SILVER | GOLD | PLATINUM
  caps_reward Int    @default(0)
  xp_reward   Int    @default(0)
  
  // Criteria stored as JSON
  criteria    Json

  created_at DateTime @default(now())

  userAchievements UserAchievement[]

  @@index([category])
  @@index([tier])
}

model UserAchievement {
  id             String   @id @default(uuid())
  user_id        String
  achievement_id String
  unlocked_at    DateTime @default(now())
  progress       Json?    // For progressive achievements

  user        User        @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id])
}

// ==================== CONTENT MODERATION ====================
model ContentFlag {
  id          String   @id @default(uuid())
  reporter_id String
  target_type String // POST | COMMENT | USER | VENDOR | RATING
  target_id   String
  reason      String
  details     String?  @db.VarChar(500)
  status      String   @default("PENDING") // PENDING | REVIEWED | ACTIONED | DISMISSED
  reviewed_by String?
  reviewed_at DateTime?
  action_taken String?
  created_at  DateTime @default(now())

  reporter User @relation(fields: [reporter_id], references: [uuid], onDelete: Cascade)

  @@index([target_type, target_id])
  @@index([status])
  @@index([created_at(sort: Desc)])
}

// ==================== REFERRALS ====================
model ReferralCode {
  id         String   @id @default(uuid())
  user_id    String   @unique
  code       String   @unique
  uses_count Int      @default(0)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())

  user User          @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  uses ReferralUse[]

  @@index([code])
}

model ReferralUse {
  id               String   @id @default(uuid())
  referral_code_id String
  referred_user_id String   @unique
  caps_awarded     Int      @default(100)
  created_at       DateTime @default(now())

  referralCode ReferralCode @relation(fields: [referral_code_id], references: [id], onDelete: Cascade)
  referredUser User         @relation("ReferredUser", fields: [referred_user_id], references: [uuid], onDelete: Cascade)

  @@index([referral_code_id])
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id          String   @id @default(uuid())
  user_id     String
  type        String   // FOLLOW | LIKE | COMMENT | EXPEDITION_INVITE | ACHIEVEMENT | SYSTEM
  title       String
  body        String
  data        Json?    // Additional data like post_id, user_id, etc.
  is_read     Boolean  @default(false)
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [uuid], onDelete: Cascade)

  @@index([user_id, is_read])
  @@index([user_id, created_at(sort: Desc)])
}

// ==================== ADMIN LOGS ====================
model AdminLog {
  id          String   @id @default(uuid())
  admin_id    String
  action      String
  target_type String?
  target_id   String?
  details     Json?
  ip_address  String?
  created_at  DateTime @default(now())

  @@index([admin_id])
  @@index([action])
  @@index([created_at(sort: Desc)])
}

// ==================== APP CONFIG ====================
model AppConfig {
  key        String   @id
  value      Json
  updated_at DateTime @updatedAt
}
